#!/bin/bash

escape_line() {
  line=${*//\//\\\/}
  line=${line//\*/\\\*}
  line=${line//\#/\\\#}
  line=${line//\"/\\\"}
  echo "$line"
}

filename="$1"
if [ "$filename" == "" ]; then
  filename="/tmp/results.replace-all"
fi

cat "$filename" | while read line; do
  filename=${line%%:*}
  linenum=${line#*:}
  linenum=${linenum%%:*}
  line=${line#*:*:}
  escaped_line=$(escape_line "$line")

  actual_line=$(sed "${linenum}q;d" "$filename")
  if [ "$actual_line" == "$line" ]; then
    echo "Skipping $filename:$linenum (identical)"
  else
    echo "Changing $filename:$linenum"
    echo "  $line"
    sed -e "${linenum}s/.*/$escaped_line/" -i .replace-backup "$filename"
    rm "${filename}.replace-backup"
  fi

done


